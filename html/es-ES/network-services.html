<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">Capítulo 11. Servicios de red: Postfix, Apache, NFS, Samba, Squid, LDAP</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.1" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-8-es-ES-1.0-1" /><meta
        name="keywords"
        content="Postfix, Apache, NFS, Samba, Squid, OpenLDAP" /><link
        rel="home"
        href="index.html"
        title="El libro del administrador de Debian" /><link
        rel="up"
        href="index.html"
        title="El libro del administrador de Debian" /><link
        rel="prev"
        href="sect.network-diagnosis-tools.html"
        title="10.8. Herramientas de diagnóstico de red" /><link
        rel="next"
        href="sect.http-web-server.html"
        title="11.2. Servidor web (HTTP)" /><link
        rel="canonical"
        href="http://l.github.io/debian-handbook/html/es-ES/network-services.html" /></head><body
      class="draft "><noscript><iframe
          src="//www.googletagmanager.com/ns.html?id=GTM-5H35QX"
          height="0"
          width="0"
          style="display:none;visibility:hidden"></iframe></noscript><script
        type="text/javascript">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&amp;l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5H35QX');</script><div
        id="banner"><a
          href="http://debian-handbook.info/get/"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="http://debian-handbook.info"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="sect.network-diagnosis-tools.html"><strong>Anterior</strong></a></li><li
          class="home">El libro del administrador de Debian</li><li
          class="next"><a
            accesskey="n"
            href="sect.http-web-server.html"><strong>Siguiente</strong></a></li></ul><div
        xml:lang="es-ES"
        class="chapter"
        lang="es-ES"><div
          class="titlepage"><div><div><h1
                class="title"><a
                  id="network-services"></a>Capítulo 11. Servicios de red: Postfix, Apache, NFS, Samba, Squid, LDAP</h1></div></div></div><div
          class="toc"><dl
            class="toc"><dt><span
                class="section"><a
                  href="network-services.html#sect.smtp-mail-server">11.1. Servidor de correo</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="network-services.html#idm139951632404848">11.1.1. Instalación de Postfix</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm139951630437024">11.1.2. Configuración de dominios virtuales</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm139951627828144">11.1.3. Restricciones para recibir y enviar</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm139951629294272">11.1.4. Configuración de «listas grises» (<span
                        class="foreignphrase"><em
                          class="foreignphrase">greylisting</em></span>)</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm139951629271904">11.1.5. Personalización de filtros basados en el receptor</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#sect.postfix-antivirus">11.1.6. Integración con un antivirus</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#idm139951629234128">11.1.7. SMTP autenticado</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.http-web-server.html">11.2. Servidor web (HTTP)</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#idm139951629198624">11.2.1. Instalación de Apache</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#idm139951631045344">11.2.2. Configuración de servidores virtuales («virtual hosts»)</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#idm139951631021776">11.2.3. Directivas comunes</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#idm139951630940000">11.2.4. Analizadores de registros</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.ftp-file-server.html">11.3. Servidor de archivos FTP</a></span></dt><dt><span
                class="section"><a
                  href="sect.nfs-file-server.html">11.4. Servidor de archivos NFS</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.nfs-file-server.html#idm139951630879680">11.4.1. Protección de NFS</a></span></dt><dt><span
                    class="section"><a
                      href="sect.nfs-file-server.html#idm139951630843552">11.4.2. Servidor NFS</a></span></dt><dt><span
                    class="section"><a
                      href="sect.nfs-file-server.html#idm139951609205184">11.4.3. Cliente NFS</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.windows-file-server-with-samba.html">11.5. Configuración de espacios compartidos Windows con Samba</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.windows-file-server-with-samba.html#idm139951609185936">11.5.1. Servidor Samba</a></span></dt><dt><span
                    class="section"><a
                      href="sect.windows-file-server-with-samba.html#idm139951609136544">11.5.2. Cliente Samba</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.http-ftp-proxy.html">11.6. Proxy HTTP/FTP</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.http-ftp-proxy.html#idm139951609096944">11.6.1. Instalación</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-ftp-proxy.html#idm139951609091664">11.6.2. Configuración de un caché</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-ftp-proxy.html#idm139951609087888">11.6.3. Configuración de un filtro</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.ldap-directory.html">11.7. Directorio LDAP</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.ldap-directory.html#idm139951609065568">11.7.1. Instalación</a></span></dt><dt><span
                    class="section"><a
                      href="sect.ldap-directory.html#idm139951609046128">11.7.2. Relleno del directorio</a></span></dt><dt><span
                    class="section"><a
                      href="sect.ldap-directory.html#idm139951609017024">11.7.3. Administración de cuentas con LDAP</a></span></dt></dl></dd></dl></div><div
          class="highlights"><div
            class="para">
		Los servicios de red son los programas con los que los usuarios interactúan en su trabajo diario. Son la punta del iceberg del sistema de información y este capítulo se centra en ellos; las partes ocultas en las que se basan son la infraestructura que ya hemos descripto anteriormente.
	</div></div><div
          class="section"><div
            class="titlepage"><div><div><h2
                  class="title"><a
                    id="sect.smtp-mail-server"></a>11.1. Servidor de correo</h2></div></div></div><div
            class="para">
			Los administradores de Falcot Corp eligieron Postfix como servidor de correo electrónico debido a su fiabilidad y su facilidad de configuración. De hecho, su diseño fuerza a que cada tarea sea implementada en un proceso con el mínimo conjunto de permisos, lo que es una gran medida paliativa contra problemas de seguridad.
		</div><a
            id="idm139951632448480"
            class="indexterm"></a><a
            id="idm139951618543376"
            class="indexterm"></a><a
            id="idm139951613011776"
            class="indexterm"></a><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>ALTERNATIVA</em></span> El servidor Exim4</strong></p></div></div></div><a
              id="idm139951632420176"
              class="indexterm"></a><div
              class="para">
			Debian utiliza Exim4 como servidor de correo predeterminado (razón por la que la instalación inicial incluye Exim4). Un paquete diferente provee su configuración, <span
                class="pkg pkg">exim4-config</span>, la cual es personalizada automáticamente basándose en las respuestas a un conjunto de preguntas Debconf muy similares a las que pregunta el paquete <span
                class="pkg pkg">postfix</span>.
		</div><div
              class="para">
			La configuración puede estar en un único archivo (<code
                class="filename">/etc/exim4/exim4.conf.template</code>) o dividida en diferentes trozos que se almacenan en el directorio <code
                class="filename">/etc/exim4/conf.d/</code>. En ambos casos, <code
                class="command">update-exim4.conf</code> utiliza los archivos como plantillas para generar <code
                class="filename">/var/lib/exim4/config.autogenerated</code> . Exim4 utiliza este último archivo. Gracias a este mecanismo, se pueden introducir los valores definidos durante la configuración debconf de Exim — almacenados en <code
                class="filename">/etc/exim4/update-exim4.conf.conf</code> — en el archivo de configuración de Exim aún cuando el administrador y otro paquete haya modificado la configuración predeterminada de Exim.
		</div><div
              class="para">
			La sintaxis de los archivos de configuración de Exim4 tiene sus peculiaridades y curva de aprendizaje. Sin embargo, una vez que se entienden estas peculiaridades, Exim4 resulta ser un servidor de correo muy completo y potente, como se puede apreciar en las decenas de páginas de documentación. <div
                class="url">→ <a
                  href="http://www.exim.org/docs.html">http://www.exim.org/docs.html</a></div>
		</div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm139951632404848"></a>11.1.1. Instalación de Postfix</h3></div></div></div><div
              class="para">
				El paquete <span
                class="pkg pkg">postfix</span> incluye el demonio SMTP principal. Otros paquetes (como <span
                class="pkg pkg">postfix-ldap</span> y <span
                class="pkg pkg">postfix-pgsql</span>) añaden funcionalidad adicional, incluyendo el acceso a bases de datos. Sólo debe instalarlos si sabe que los necesitará.
			</div><div
              class="sidebar"><a
                id="sidebar.smtp"></a><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>VOLVER A LOS CIMIENTOS</em></span> SMTP</strong></p></div></div></div><a
                id="idm139951619508048"
                class="indexterm"></a><a
                id="idm139951619507088"
                class="indexterm"></a><a
                id="idm139951619506160"
                class="indexterm"></a><div
                class="para">
				SMTP (protoclo sencillo de transferencia de correo: «<span
                  class="emphasis"><em>Simple Mail Transfer Protocol</em></span>») es el protocolo que utilizan los servidores de correo para intercambiar y enrutar los correos electrónicos.
			</div></div><div
              class="para">
				Durante la instalación del paquete se realizan varias preguntas Debconf. Las respuestas permiten crear una primera versión del archivo de configuración <code
                class="filename">/etc/postfix/main.cf</code>.
			</div><div
              class="para">
				La primera pregunta es sobre el tipo de instalación. Sólamente dos de las respuestas propuestas son relevantes en caso de tener un servidor conectado a Internet: «Sitio de Internet» e «Internet con smarthost». La primera es apropiada para un servidor que recibe correo entrante y envía el correo saliente directamente a los destinatarios, y por lo tanto se adapta al caso del Falcot Corp. La segunda es apropiada para un servidor que recibe correo de forma normal pero que envía el correo saliente a través de otro servidor SMTP intermedio — el «smarthost» — en lugar de enviarlo directamente al servidor de los destinatarios. Esto es especialmente útil para individuos con una dirección IP dinámica puesto que muchos servidores de correo rechazan los mensajes que vienen desde este tipo de dirección. En este caso, el smarthost es normalmente el servidor SMTP del ISP que siempre suele estar configurado para aceptar los correos provenientes de sus clientes y reenviarlos correctamente. Este tipo de instalación (con un smarthost) también es útil para servidores que no estén conectados permanentemente a Internet puesto que impide tener que gestionar una cola de mensajes no entregables que tienen que volver a ser enviados más tarde.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>VOCABULARIO</em></span> ISP</strong></p></div></div></div><a
                id="idm139951631244400"
                class="indexterm"></a><div
                class="para">
				ISP es la sigla de «Proveedor de servicios de Internet» («Internet Service Provider»). Se trata de una entidad, a menudo una empresa comercial, que proporciona conexiones de Internet y los servicios básicos asociados (correo electrónico, noticias, etc.).
			</div><div
                class="para">
			</div></div><div
              class="para">
				La segunda pregunta es sobre el nombre completo de la máquina y se utiliza para generar las direcciones de correo a partir de los nombres de usuario locales; el nombre completo de la máquina se convierte en la parte de la dirección que sigue a la arroba («@»). En el caso de Falcot, la respuesta debería ser <code
                class="literal">mail.falcot.com</code>. Esta es la única pregunta que se hace de forma predeterminada, pero la configuración que genera no es lo suficientemente completa para las necesidades de Falcot, por lo que los administradores deben ejecutar <code
                class="command">dpkg-reconfigure</code> para poder personalizar más parámetros.
			</div><div
              class="para">
				Una de las preguntas adicionales pide los nombres de los dominios relacionados con la máquina. La lista inicial incluye su nombre completo así como también algunos sinónimos de <code
                class="literal">localhost</code>, pero el dominio principal <code
                class="literal">falcot.com</code> tiene que ser agregado de forma manual. En general se deberían añadir todos los dominios para los que esta máquina debe ejercer como servidor MX; en otras palabras, todos los dominios para los cuales el DNS anuncie que esta máquina aceptará correo. Esta información acaba siendo escrita en la variable <code
                class="literal">mydestination</code> del archivo de configuración principal de Postfix — <code
                class="filename">/etc/postfix/main.cf</code>.
			</div><a
              id="idm139951629434800"
              class="indexterm"></a><a
              id="idm139951629433360"
              class="indexterm"></a><div
              class="figure"><a
                id="idm139951629431920"></a><div
                class="figure-contents"><div
                  class="mediaobject"><img
                    src="images/mail-server.png"
                    alt="Rol del registro DNS MX al enviar un correo" /></div></div><p
                class="title"><strong>Figura 11.1. Rol del registro DNS <span
                    class="emphasis"><em>MX</em></span> al enviar un correo</strong></p></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>EXTRA</em></span> Consulta de los registros MX</strong></p></div></div></div><div
                class="para">
				Cuando no existe un registro MX para un dominio en DNS, el servidor de correo intentará enviar el mensaje a la dirección del equipo directamente, utilizando para ello el registro A (o AAAA en IPv6).
			</div></div><div
              class="para">
				En algunos casos, la instalación también puede preguntar desde qué redes se permitirá enviar correo a través de la máquina. En la configuración predeterminada, Postfix únicamente acepta correos que provengan desde la propia máquina; normalmente agregará la red local. Los administradores de Falcot Corp añadieron la red <code
                class="literal">192.168.0.0/16</code> al valor predeterminado. Si no se realiza esta pregunta durante la instalación, la variable de configuración correspondiente es <code
                class="literal">mynetworks</code>, tal y como puede verse en el ejemplo siguiente.
			</div><div
              class="para">
				El correo local también puede ser entregado mediante <code
                class="command">procmail</code>. Esta herramienta permite a los usuarios clasificar su correo en función de reglas contenidas en su archivo <code
                class="filename">~/.procmailrc</code>.
			</div><a
              id="idm139951629423168"
              class="indexterm"></a><a
              id="idm139951629422048"
              class="indexterm"></a><a
              id="idm139951630446000"
              class="indexterm"></a><div
              class="para">
				Después de este paso, los administradores obtuvieron el siguiente archivo de configuración; será usado en las siguientes secciones como punto de partida para agregar alguna funcionalidad adicional.
			</div><div
              class="example"><a
                id="idm139951630444368"></a><p
                class="title"><strong>Ejemplo 11.1. Archivo <code
                    class="filename">/etc/postfix/main.cf</code> inicial</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# See /usr/share/postfix/main.cf.dist for a commented, more complete version


# Debian specific:  Specifying a file name will cause the first
# line of that file to be used as the name.  The Debian default
# is /etc/mailname.
#myorigin = /etc/mailname

smtpd_banner = $myhostname ESMTP $mail_name (Debian/GNU)
biff = no

# appending .domain is the MUA's job.
append_dot_mydomain = no

# Uncomment the next line to generate "delayed mail" warnings
#delay_warning_time = 4h

readme_directory = no

# TLS parameters
smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_use_tls=yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache

# See /usr/share/doc/postfix/TLS_README.gz in the postfix-doc package for
# information on enabling SSL in the smtp client.

myhostname = mail.falcot.com
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
myorigin = /etc/mailname
mydestination = mail.falcot.com, falcot.com, localhost.localdomain, localhost
relayhost = 
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 192.168.0.0/16
mailbox_command = procmail -a "$EXTENSION"
mailbox_size_limit = 0
recipient_delimiter = +
inet_interfaces = all
inet_protocols = all
</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>SEGURIDAD</em></span> Certificados SSL de <span
                          class="emphasis"><em>Snake oil</em></span></strong></p></div></div></div><div
                class="para">
				Los certificados <span
                  class="emphasis"><em>snake oil</em></span>, al igual que los medicamentos vendidos por charlatanes sin escrúpulos en los viejos tiempos (promocionados como <span
                  class="emphasis"><em>aceite de serpiente</em></span>, de ahí su nombre), no tienen absolutamente ningún valor puesto que se generan de forma idéntica en todos los sistemas Debian, con la misma parte «privada». Deben utilizarse exclusivamente para pruebas y el servicio normal debe utilizar certificados reales; puede generarlos utilizado el procedimiento descripto en la <a
                  class="xref"
                  href="sect.virtual-private-network.html#sect.easy-rsa">Sección 10.2.1.1, “Infraestructura de llave pública: <span
                    class="emphasis"><em>easy-rsa</em></span>”</a>.
			</div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm139951630437024"></a>11.1.2. Configuración de dominios virtuales</h3></div></div></div><a
              id="idm139951630436256"
              class="indexterm"></a><a
              id="idm139951630434816"
              class="indexterm"></a><div
              class="para">
				El servidor de correo puede recibir correos dirigidos a otros dominios distintos del dominio principal; estos dominios se conocen como «dominios virtuales». En la mayoría de los casos en los que es así, los correos no se dirigen en última instancia a los usuarios locales. Postfix proporciona dos características interesantes para gestionar dominios virtuales.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>ATENCIÓN</em></span> Dominios virtuales y dominios canónicos</strong></p></div></div></div><div
                class="para">
				No se debe hacer referencia a ninguno de los dominios virtuales en la variable <code
                  class="literal">mydestination</code>; esta variable únicamente contiene los nombres de los dominios «canónicos» asociados directamente con la máquina y sus usuarios locales.
			</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm139951630430720"></a>11.1.2.1. Alias de dominio virtual</h4></div></div></div><a
                id="idm139951630429952"
                class="indexterm"></a><a
                id="idm139951629391600"
                class="indexterm"></a><div
                class="para">
					Un «alias de dominio virtual» («virtual alias domain») únicamente contiene alias, es decir direcciones que únicamente reenvían los correos hacia otras direcciones.
				</div><div
                class="para">
					Para habilitar un dominio de este tipo, agregue su nombre a la variable <code
                  class="literal">virtual_alias_domains</code> y establezca un archivo de traducción de direcciones en la variable <code
                  class="literal">virtual_alias_maps</code>.
				</div><div
                class="example"><a
                  id="idm139951629388144"></a><p
                  class="title"><strong>Ejemplo 11.2. Directivas a agregar en el archivo <code
                      class="filename">/etc/postfix/main.cf</code></strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
virtual_alias_domains = falcotsbrand.com
virtual_alias_maps = hash:/etc/postfix/virtual
</pre></div></div><div
                class="para">
					The <code
                  class="filename">/etc/postfix/virtual</code> file describes a mapping with a rather straightforward syntax: each line contains two fields separated by whitespace; the first field is the alias name, the second field is a list of email addresses where it redirects. The special <code
                  class="literal">@domain.com</code> syntax covers all remaining aliases in a domain.
				</div><div
                class="example"><a
                  id="idm139951629384816"></a><p
                  class="title"><strong>Ejemplo 11.3. Archivo <code
                      class="filename">/etc/postfix/virtual</code> de ejemplo</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
webmaster@falcotsbrand.com  jean@falcot.com
contact@falcotsbrand.com    laure@falcot.com, sophie@falcot.com
# The alias below is generic and covers all addresses within 
# the falcotsbrand.com domain not otherwise covered by this file.
# These addresses forward email to the same user name in the
# falcot.com domain.
@falcotsbrand.com           @falcot.com
</pre></div></div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm139951629382400"></a>11.1.2.2. Casillas de dominio virtual</h4></div></div></div><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>PRECAUCIÓN</em></span> ¿Dominio virtual combinado?</strong></p></div></div></div><div
                  class="para">
					Postfix no permite utilizar el mismo dominio en <code
                    class="literal">virtual_alias_domains</code> y <code
                    class="literal">virtual_mailbox_domains</code>. Sin embargo, cada dominio de <code
                    class="literal">virtual_mailbox_domains</code> es incluido implícitamente en <code
                    class="literal">virtual_alias_domains</code> lo que permite mezclar alias y casillas en un dominio virtual.
				</div></div><a
                id="idm139951629378112"
                class="indexterm"></a><a
                id="idm139951629377184"
                class="indexterm"></a><div
                class="para">
					Los mensajes dirigidos a una casilla de dominio virtual son almacenados en casillas que no están asignadas a un usuario local del sistema.
				</div><div
                class="para">
					Activar una casilla de dominio virtual requiere agregar este dominio en la variable <code
                  class="literal">virtual_mailbox_domains</code> y hacer referencia a un archivo de asociación de casillas en <code
                  class="literal">virtual_mailbox_maps</code>. El parámetro <code
                  class="literal">virtual_mailbox_base</code> contiene el directorio en el que se almacenarán todas las casillas.
				</div><div
                class="para">
					El parámetro <code
                  class="literal">virtual_uid_maps</code> (o <code
                  class="literal">virtual_gid_maps</code> respectivamente) hace referencia al archivo que contiene la asociación entre las direcciones de correo y el usuario de sistema (o grupo respectivamente) «dueño» de la casilla correspondiente. Para lograr que todas las casillas pertenezcan al mismo usuario/grupo, la sintaxis <code
                  class="literal">static:5000</code> asigna un UID/GID fijo (aquí el valor 5000).
				</div><div
                class="example"><a
                  id="idm139951627837264"></a><p
                  class="title"><strong>Ejemplo 11.4. Directivas a agregar en el archivo <code
                      class="filename">/etc/postfix/main.cf</code></strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
virtual_mailbox_domains = falcot.org
virtual_mailbox_maps = hash:/etc/postfix/vmailbox
virtual_mailbox_base = /var/mail/vhosts
</pre></div></div><div
                class="para">
					Nuevamente, la sintaxis del archivo <code
                  class="filename">/etc/postfix/vmailbox</code> es bastante directo: dos campos separados con espacios en blanco. El primer campo es una dirección de correo en alguno de los dominios virtuales y el segundo campo es la ubicación de la casilla asociada (relativa al directorio especificado en <span
                  class="emphasis"><em>virtual_mailbox_base</em></span>). Si el nombre de la casilla finaliza con una barra (<code
                  class="literal">/</code>), se almacenarán los correos en formato <span
                  class="emphasis"><em>maildir</em></span>; de lo contrario se utilizará el formato <span
                  class="emphasis"><em>mbox</em></span> tradicional. El formato <span
                  class="emphasis"><em>maildir</em></span> utiliza un directorio completo para almacenar una casilla, cada mensaje individual es almacenado en un archivo separado. Por el otro lado, en el formato <span
                  class="emphasis"><em>mbox</em></span> se almacena toda la casilla en un archivo y cada línea que comience con «<code
                  class="literal">From </code> (<code
                  class="literal">From</code> es seguido por un espacio) indica el comienzo de un nuevo mensaje.
				</div><div
                class="example"><a
                  id="idm139951627830480"></a><p
                  class="title"><strong>Ejemplo 11.5. El archivo <code
                      class="filename">/etc/postfix/vmailbox</code></strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
# Jean's email is stored as maildir, with
# one file per email in a dedicated directory
jean@falcot.org falcot.org/jean/
# Sophie's email is stored in a traditional "mbox" file,
# with all mails concatenated into one single file
sophie@falcot.org falcot.org/sophie
</pre></div></div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm139951627828144"></a>11.1.3. Restricciones para recibir y enviar</h3></div></div></div><div
              class="para">
				La cantidad creciente de correo masivo no solicitado (<span
                class="emphasis"><em>spam</em></span>) hace necesario ser cada vez más estricto al decidir qué correos debe aceptar un servidor. Esta sección presenta alguna de las estrategias incluidas en Postfix.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>CULTURA</em></span> El problema del spam</strong></p></div></div></div><a
                id="idm139951627825168"
                class="indexterm"></a><div
                class="para">
				«Spam» es un término genérico utilizado para designar todo el correo comercial no solicitado (UCE por su siglas en inglés: «Unsolicited Commercial Emails») que inundan nuestras casillas electrónicas; los individuos sin escrúpulos que lo envían son conocidos como spammers. Poco les importan las molestias que causan ya que enviar un correo cuesta muy poco y sólo necesitan atraer con sus ofertas un porcentaje muy pequeño de quienes lo reciban para que la operación de spam genere más dinero de lo que cuesta. El proceso es mayormente automático y cualquier dirección de correo que sea publicada (por ejemplo en un foro web, en los compendios de una lista de correo, en un blog, etc.) será descubierta por los robots de los spammers y víctima de un flujo interminable de mensajes no solicitados.
			</div><div
                class="para">
				Todos los administradores de sistemas intentan enfrentarse a esta molestia con filtros de spam pero, por supuesto, los spammers continúan adaptándose para evitar estos filtros. Algunos inclusive alquilan redes de máquinas comprometidas por algún gusano de varios sindicatos criminales. ¡Estadísticas recientes estiman que hasta un 95% de todos los correos circulando en Internet son spam!
			</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm139951627821904"></a>11.1.3.1. Restricciones de acceso basadas en IP</h4></div></div></div><div
                class="para">
					La directiva <code
                  class="literal">smtpd_client_restrictions</code> controla qué máquinas pueden comunicarse con el servidor de correo.
				</div><div
                class="example"><a
                  id="idm139951627820240"></a><p
                  class="title"><strong>Ejemplo 11.6. Restricciones basadas en la dirección del cliente</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_client_restrictions = permit_mynetworks,
    warn_if_reject reject_unknown_client,
    check_client_access hash:/etc/postfix/access_clientip,
    reject_rbl_client sbl-xbl.spamhaus.org,
    reject_rbl_client list.dsbl.org
</pre></div></div><div
                class="para">
					Cuando una variable contiene una lista de reglas, como en el ejemplo anterior, estas reglas son evaluadas en orden desde la primera hasta la última. Cada regla puede aceptar el mensaje, rechazarlo o dejar la decisión de qué hacer a reglas posteriores. Por lo tanto, el orden importa y cambiar el orden en el que están establecidas las reglas puede provocar un comportamiento completamente diferente.
				</div><div
                class="para">
					La directiva <code
                  class="literal">permit_mynetworks</code>, como primera regla, acepta todos los correos que provienen de equipos en la red local (definida por la variable de configuración <span
                  class="emphasis"><em>mynetworks</em></span>).
				</div><div
                class="para">
					La segunda directiva normalmente rechazará correos que provienen de equipos sin una configuración de DNS completamente válida. Esta configuración válida significa que la dirección IP está asociada a un nombre y que este nombre, además, resuelve a dicha dirección IP. Generalmente, esta restricción es demasiado estricta ya que muchos servidores de correo no tienen un DNS inverso para su dirección IP. Esto explica porqué los administradores de Falcot agregaron el modificador <code
                  class="literal">warn_if_reject</code> antes de la directiva <code
                  class="literal">reject_unkown_client</code>: este modificado convierte el rechazo en una simple advertencia guardada en los registros. Los administradores pueden revisar la cantidad de mensajes que hubiesen sido rechazados si esta regla hubiese sido aplicada y luego tomar decisiones informadas si desean activarla.
				</div><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>SUGERENCIA</em></span> Tablas <span
                            class="emphasis"><em>access</em></span></strong></p></div></div></div><div
                  class="para">
					El criterio de restricción incluye tablas que pueden ser modificadas por un administrador que contienen combinaciones de remitente, dirección IP y nombres de equipo permitidos o prohibidos. Puede crear estas tablas desde una copia descomprimida del archivo <code
                    class="filename">/usr/share/doc/postfix-doc/examples/access.gz</code>. Este modelo está documentado en sus comentarios, lo que significa que cada tabla describe su propia sintaxis.
				</div><div
                  class="para">
					La tabla <code
                    class="filename">/etc/postfix/access_clientip</code> enumera direcciones IP y redes; <code
                    class="filename">/etc/postfix/access_helo</code> enumera nombres de dominio; <code
                    class="filename">/etc/postfix/access_sender</code> contiene direcciones de correo de remintentes. Necesita convertir todos estos archivos en «tablas hash» (un formato optimizado para acceso rápido) luego de cada cambio ejecutando <code
                    class="command">postmap /etc/postfix/<em
                      class="replaceable">archivo</em></code>.
				</div></div><div
                class="para">
					La tercera directiva permite al administrador definir listas negras y blancas de servidores de correo, almacenadas en el archivo <code
                  class="filename">/etc/postfix/access_clientip</code>. Se consideran confiables aquellos servidores en la lista blanca y, por lo tanto, sus correos no pasarán por las siguientes reglas de filtro.
				</div><div
                class="para">
					Las últimas dos reglas rechazan cualquier mensaje que provenga de un servidor incluido en una de las listas negras indicadas. RBL es un acrónimo de <span
                  class="emphasis"><em>Remote Black List</em></span> (lista negra remota); hay muchas de estas listas pero todas enumeran servidores mal configurados que los spammers utilizan para redirigir sus correos así como también equipos inesperados como máquinas infectadas con algún gusano o virus.
				</div><a
                id="idm139951627805920"
                class="indexterm"></a><a
                id="idm139951627804960"
                class="indexterm"></a><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>SUGERENCIA</em></span> Listas blancas y RBLs</strong></p></div></div></div><div
                  class="para">
					Las listas negras a veces incluyen un servidor legítimo que ha sufrido un incoveniente. En estas situaciones, se rechazarán todos los correos que provengan de alguno de estos servidores a menos que el servidor esté incluido en una lista blanca definida en <code
                    class="filename">/etc/postfix/access_clientip</code>.
				</div><div
                  class="para">
					La prudencia recomienda entonces incluir en la lista blanca todos los servidores confiables desde los que frecuentemente recibirá muchos correos.
				</div></div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm139951627800752"></a>11.1.3.2. Revisión de la validez de las órdenes <code
                        class="literal">EHLO</code> o <code
                        class="literal">HELO</code></h4></div></div></div><div
                class="para">
					Cada intercambio SMTP comienza con la orden <code
                  class="literal">HELO</code> (o <code
                  class="literal">EHLO</code>) seguida del nombre del servidor que envía el correo; puede ser interesante validar este nombre.
				</div><a
                id="idm139951627797808"
                class="indexterm"></a><a
                id="idm139951627796688"
                class="indexterm"></a><div
                class="example"><a
                  id="idm139951627795568"></a><p
                  class="title"><strong>Ejemplo 11.7. Restricciones en el nombre anunciado con <code
                      class="literal">EHLO</code></strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_helo_restrictions = permit_mynetworks,
    reject_invalid_hostname,
    check_helo_access hash:/etc/postfix/access_helo,
    reject_non_fqdn_hostname,
    warn_if_reject reject_unknown_hostname
</pre></div></div><div
                class="para">
					La primera directiva <code
                  class="literal">permit_my_networks</code> permite que todas las máquinas en la red local se presenten libremente. Esto es importante ya que algunos programas de correo no respetan esta parte del protocolo SMTP de forma suficientemente correcta y pueden presentarse a sí mismos con nombres sin sentido.
				</div><div
                class="para">
					La regla <code
                  class="literal">reject_invalid_hostname</code> rechaza los correos cuando el anuncio <code
                  class="literal">EHLO</code> enumere un nombre sintácticamente incorrecto. La regla <code
                  class="literal">reject_non_fqdn_hostname</code> rechaza mensajes cuando el nombre anunciado no es un nombre de dominio completamente calificado (incluye un nombre de dominio así como también el nombre del equipo). La regla <code
                  class="literal">reject_unkown_hostname</code> rechaza los mensajes si el nombre anunciado no existe en su DNS. Los administradores hicieron que los efectos de esta regla sean sólo una advertencia con el modificador <code
                  class="literal">warn_if_reject</code> debido a que, lamentablemente, genera demasiados rechazos. Esto es sólo un primer paso, pueden decidir eliminar el modificador en el futuro luego de analizar los resultados de esta regla.
				</div><div
                class="para">
					Utilizar <code
                  class="literal">permit_mynetworks</code> como la primera regla tiene un efecto secundario interesante: las reglas siguientes sólo serán aplicadas a los equipos fuera de la red local. Esto permite rechazar todos los equipos que se anuncien a sí mismos como parte de <code
                  class="literal">falcot.com</code>, por ejemplo agregando una línea <code
                  class="literal">falcot.com REJECT ¡No es parte de nuestra red!</code> en el archivo <code
                  class="filename">/etc/postfix/access_helo</code>.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm139951627786512"></a>11.1.3.3. Aceptación o rechazo basado en el remitente anunciado</h4></div></div></div><div
                class="para">
					Cada mensaje tiene un remitente anunciado con la orden <code
                  class="literal">MAIL FROM</code> del protocolo SMTP; nuevamente, puede validar esta información de varias formas.
				</div><a
                id="idm139951627784848"
                class="indexterm"></a><a
                id="idm139951627783728"
                class="indexterm"></a><div
                class="example"><a
                  id="idm139951627782288"></a><p
                  class="title"><strong>Ejemplo 11.8. Verificación de remitente</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_sender_restrictions = 
    check_sender_access hash:/etc/postfix/access_sender,
    reject_unknown_sender_domain, reject_unlisted_sender,
    reject_non_fqdn_sender
</pre></div></div><div
                class="para">
					La tabla <code
                  class="filename">/etc/postfix/access_sender</code> asocia algún tratamiento especial a algunos remitentes. Esto generalmente significa enumerar algunos remitentes en una lista negra o blanca.
				</div><div
                class="para">
					La regla <code
                  class="literal">reject_unknown_sender_domain</code> requiere un remitente con dominio válido, ya que es necesario en una dirección válida. La regla <code
                  class="literal">reject_unlisted_sender</code> rechaza remitentes locales si la dirección no existe; esto evita que se envíen correos desde una dirección inválida en el dominio <code
                  class="literal">falcot.com</code> y los mensajes de <code
                  class="literal">joe.bloggs@falcot.com</code> sólo son aceptados si existe dicha dirección.
				</div><div
                class="para">
					Finalmente, la regla <code
                  class="literal">reject_non_fqdn_sender</code> rechaza los correos que dicen provenir de direcciones sin un nombre de dominio completamente calificado. En la práctica significa rechazar correos que provienen de <code
                  class="literal">usuario@equipo</code>: la dirección debe anunciarse como <code
                  class="literal">usuario@equipo.example.com</code> o <code
                  class="literal">usuario@example.com</code>.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm139951629337120"></a>11.1.3.4. Aceptación o rechazo basado en el receptor</h4></div></div></div><div
                class="para">
					Cada correo tiene al menos un receptor, anunciado con la orden <code
                  class="literal">RCPT TO</code> en el protocolo SMTP. Estas direcciones también requieren validación, aún si pueden ser menos relevantes que las verificaciones realizadas en la dirección del remitente.
				</div><a
                id="idm139951629335264"
                class="indexterm"></a><a
                id="idm139951629334304"
                class="indexterm"></a><div
                class="example"><a
                  id="idm139951629332864"></a><p
                  class="title"><strong>Ejemplo 11.9. Verificación de receptor</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_recipient_restrictions = permit_mynetworks, 
    reject_unauth_destination, reject_unlisted_recipient, 
    reject_non_fqdn_recipient
</pre></div></div><div
                class="para">
					<code
                  class="literal">reject_unauth_destination</code> is the basic rule that requires outside messages to be addressed to us; messages sent to an address not served by this server are rejected. Without this rule, a server becomes an open relay that allows spammers to send unsolicited emails; this rule is therefore mandatory, and it will be best included near the beginning of the list, so that no other rules may authorize the message before its destination has been checked.
				</div><div
                class="para">
					La regla <code
                  class="literal">reject_unlisted_recipient</code> rechaza los mensajes enviados a usuarios locales que no existen, lo que tiene sentido. Finalmente, la regla <code
                  class="literal">reject_non_fqdn_recipient</code> rechaza direcciones que no sean completamente calificadas; esto hace imposible enviar un correo a <code
                  class="literal">jean</code> o <code
                  class="literal">jean@equipo</code> y necesita, en cambio, utilizar la dirección completa como <code
                  class="literal">literal@equipo.falcot.com</code> o <code
                  class="literal">jean@falcot.com</code>.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm139951629326528"></a>11.1.3.5. Restricciones asociadas con la orden <code
                        class="literal">DATA</code></h4></div></div></div><div
                class="para">
					Se emite la orden <code
                  class="literal">DATA</code> en SMTP antes del contenido del mensaje. No provee ninguna información en sí misma además de anunciar lo que seguirá. Todavía puede ser sujeta a verificación.
				</div><a
                id="idm139951629324352"
                class="indexterm"></a><div
                class="example"><a
                  id="idm139951629323232"></a><p
                  class="title"><strong>Ejemplo 11.10. Verificación de <code
                      class="literal">DATA</code></strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_data_restrictions = reject_unauth_pipelining
</pre></div></div><div
                class="para">
					Las directivas <code
                  class="literal">reject_unauth_pipelining</code> causa que se rechace el mensaje si el remitente envía una orden antes que se envía la respuesta a la orden anterior. Esto previene una optimización común utilizada por los robots de spammers ya que no tienen el menor interés en las respuestas y sólo están interesados en enviar tantos correos como sea posible en el menor tiempo posible.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm139951629320080"></a>11.1.3.6. Implementación de restricciones</h4></div></div></div><div
                class="para">
					Si bien las órdenes anteriores validan la información en las varias etapas del intercambio SMTP, Postfix sólo envía el rechazo en sí como respuesta a la orden <code
                  class="literal">RCPT TO</code>.
				</div><div
                class="para">
					Esto significa que aún si se rechaza el mensaje debido a una orden <code
                  class="literal">EHLO</code> no válida, Postfix conoce el remitente y el receptor cuando anuncia un rechazo. Luego puede registrar un mensaje más explícito de lo que podría si se hubiera interrumpido la transacción al comienzo. Además, una cantidad de clientes SMTP no esperan fallos en las primeras órdenes de SMTP y estos clientes no se molestarán tanto por este rechazo tardío.
				</div><div
                class="para">
					Una ventaja final de esta opción es que las reglas pueden acumular información durante las varias etapas del intercambio SMTP; esto permite definir permisos más precisos, como rechazar conexiones remotas si se anuncia como un remitente local.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        id="idm139951629316032"></a>11.1.3.7. Filtros basados en el contenido del mensaje</h4></div></div></div><div
                class="para">
					The validation and restriction system would not be complete without a way to apply checks to the message contents. Postfix differentiates the checks applying to the email headers from those applying to the email body.
				</div><div
                class="example"><a
                  id="idm139951629314576"></a><p
                  class="title"><strong>Ejemplo 11.11. Habilitación de filtros basados en contenido</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
header_checks = regexp:/etc/postfix/header_checks
body_checks = regexp:/etc/postfix/body_checks
</pre></div></div><a
                id="idm139951629313200"
                class="indexterm"></a><div
                class="para">
					Ambos archivos contienen una lista de expresiones regulares (normalmente conocidas como <span
                  class="emphasis"><em>regexps</em></span> o <span
                  class="emphasis"><em>regexes</em></span>) y las acciones asociadas que se deben disparar cuando las cabeceras (o cuerpo) del mensaje coincida con la expresión.
				</div><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>VISTA RÁPIDA</em></span> Tablas de expresiones regulares («regexp»)</strong></p></div></div></div><div
                  class="para">
					El archivo <code
                    class="filename">/usr/share/doc/postfix-doc/examples/header_checks.gz</code> contiene muchos comentarios explicativos y puede utilizarlo como punto de partida para crear los archivos <code
                    class="filename">/etc/postfix/header_checks</code> y <code
                    class="filename">/etc/postfix/body_checks</code>.
				</div></div><div
                class="example"><a
                  id="idm139951629307072"></a><p
                  class="title"><strong>Ejemplo 11.12. Archivo <code
                      class="filename">/etc/postfix/header_checks</code> de ejemplo</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
/^X-Mailer: GOTO Sarbacane/ REJECT I fight spam (GOTO Sarbacane)
/^Subject: *Your email contains VIRUSES/ DISCARD virus notification
</pre></div></div><div
                class="sidebar"><a
                  id="sidebar.regexp"></a><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>VOLVER A LOS CIMIENTOS</em></span> Expresiones regulares</strong></p></div></div></div><div
                  class="para">
					El término <span
                    class="emphasis"><em>expresión regular</em></span> (acortado como <span
                    class="emphasis"><em>regexp</em></span> o <span
                    class="emphasis"><em>regex</em></span>) hace referencia a una notación genérica para expresar una descripción del contenido o estructura de una cadena de caracteres. Algunos caracteres especiales permiten definir alternativas (por ejemplo <code
                    class="literal">foo|bar</code> coincidirá tanto «foo» como «bar»), conjuntos de caracteres permitidos (por ejemplo <code
                    class="literal">[0-9]</code> significa cualquier dígito y <code
                    class="literal">.</code> — un punto — significa cualquier carácter), cuantificadores (<code
                    class="literal">s?</code> coincidirá tanto con <code
                    class="literal">s</code> como con la cadena vacía, en otras palabras 0 o 1 ocurrencia de <code
                    class="literal">s</code>; <code
                    class="literal">s+</code> coincidirá con uno o más caracteres <code
                    class="literal">s</code> consecutivos, etc.). Los paréntesis permiten agrupar resultados de búsqueda.
				</div><div
                  class="para">
					La sintaxis exacta de estas expresiones es diferente en cada herramienta que las utilizan, pero las características básicas son similares. <div
                    class="url">→ <a
                      href="http://es.wikipedia.org/wiki/Expresión_regular">http://es.wikipedia.org/wiki/Expresión_regular</a></div>
				</div></div><div
                class="para">
					El primero revisa la cabecera que menciona el software de correo; si es <code
                  class="literal">GOTO Sarbacane</code> (un software en correo masivo), el mensaje es rechazado. La segunda expresión revisa el asunto del mensaje; si menciona una notificación de virus podemos decidir no rechazar el mensaje sino, en cambio, descartarlo inmediatamente.
				</div><div
                class="para">
					Utilizar estos filtros es un arma de doble filo ya que es sencillo crear reglas demasiado genéricas y, en consecuencia, perder correos legítimos. En estos casos, no sólo se perderán los mensajes sino que sus remitentes recibirán mensajes de error no deseados (y molestos).
				</div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm139951629294272"></a>11.1.4. Configuración de «listas grises» (<span
                      class="foreignphrase"><em
                        class="foreignphrase">greylisting</em></span>)</h3></div></div></div><a
              id="idm139951629293024"
              class="indexterm"></a><div
              class="para">
				“Greylisting” is a filtering technique according to which a message is initially rejected with a temporary error code, and only accepted on a further try after some delay. This filtering is particularly efficient against spam sent by the many machines infected by worms and viruses, since this software rarely acts as a full SMTP agent (by checking the error code and retrying failed messages later), especially since many of the harvested addresses are really invalid and retrying would only mean losing time.
			</div><div
              class="para">
				Postfix no provee listas grises de forma nativa, pero posee una funcionalidad en la que la decisión de aceptar o rechazar un mensaje dado puede ser delegada a un programa externo. El paquete <span
                class="pkg pkg">postgrey</span> contiene dicho programa, diseñado para interactuar con su servicio de delegación de políticas de acceso.
			</div><div
              class="para">
				Una vez que instaló <span
                class="pkg pkg">postgrey</span>, éste se ejecutará como un demonio que escucha en el puerto 10023. Luego puede configurar postfix para utilizarlo si agrega el parámetro <code
                class="literal">check_policy_service</code> como una restricción adicional:
			</div><pre
              class="programlisting">
smtpd_recipient_restrictions = permit_mynetworks,
    [...]
    check_policy_service inet:127.0.0.1:10023
</pre><div
              class="para">
				Cada vez que Postfix alcance esta regla, se conectará con el demonio <code
                class="command">postgrey</code> y le enviará la información del mensaje en cuestión. Por su parte, Postgrey considerará la terna compuesta por la dirección IP, el remitente y el receptor y revisará en su base de datos si ésta fue intentada recientemente. En caso que así sea, Postgrey responderá que el mensaje debe ser aceptado; de lo contrario, la respuesta indicará que el mensaje deberá ser rechazado temporalmente y agregará la terna a su base de datos.
			</div><div
              class="para">
				La principal desventaja de las listas grises es que demorará mensajes legítimos, lo que no siempre es aceptable. También aumenta la carga en los servidores que envían muchos correos legítimos.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>EN LA PRÁCTICA</em></span> Desventajas de las listas grises</strong></p></div></div></div><div
                class="para">
				En teoría, las listas grises sólo deberían demorar el primer correo de un remitente a un receptor particular, y la demora típica es del orden de minutos. La realidad, sin embargo, puede ser ligeramente diferente. Algunos ISPs grandes utilizan conjuntos de servidores SMTP y, cuando el mensaje es rechazado inicialmente, el servidor que lo reintente puede no ser el mismo que el que envió el mensaje inicial. Cuando ocurre esto, el segundo servidor también recibirá un error temporal debido a la lista gris y así sucesivamente; puede tomar varias horas hasta que la transmisión sea intentada por un servidor que ya estuvo involucrado ya que los servidores SMTP generalmente aumentan la demora entre intentos cuando éstos fallan.
			</div><div
                class="para">
				Como consecuencia, la dirección IP puede cambiar en el tiempo aún para un remitente particular. Pero hay más: la dirección del remitente también puede cambiar. Por ejemplo, muchos servidores de listas de correo codifican información extra en la dirección del remitente para poder gestionar mensajes de error (conocidos como «<span
                  class="emphasis"><em>bounces</em></span>»). Luego, puede que cada nuevo mensaje enviado a una lista de correo necesite pasar por las listas grises, lo que significa que debe ser almacenado (temporalmente) en el servidor del remitente. Para listas de correo muy grandes (con decenas de miles de suscriptos), esto puede convertirse en un problema rápidamente.
			</div><div
                class="para">
				Para mitigar estas desventajas, Postgrey gestiona listas blancas de tales sitios y los mensajes que provengan de ellas son aceptados inmediatamente sin pasar a través de las listas grises. Puede adaptar esta lista fácilmente a sus necesidades locales ya que se encuentra almacenada en el archivo <code
                  class="filename">/etc/postgrey/whitelist_clients</code>.
			</div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>YENDO MÁS ALLÁ</em></span> Listas grises selectivas con <span
                          class="pkg pkg">milter-greylist</span></strong></p></div></div></div><div
                class="para">
				También puede evitar los inconvenientes de las listas grises sólo utilizándolas en el subconjunto de clientes que ya son considerados como fuentes probables de spam (porque se encuentran en una lista negra de DNS). Esto no es posible con <span
                  class="pkg pkg">postgrey</span>, pero puede utilizar <span
                  class="pkg pkg">milter-greylist</span> de esa forma.
			</div><div
                class="para">
				En este escenario, debido a que una lista negra de DNS nunca genera un rechazo definitivo, es razonable utilizar listas negras de DNS agresivas, incluyendo aquellas que incluyen todas las direcciones IP dinámicas de clientes de ISPs (como <code
                  class="literal">pbl.spamhaus.org</code> o <code
                  class="literal">dul.dnsbl.sorbs.net</code>).
			</div><div
                class="para">
				Como milter-greylist utiliza la interfaz de milter de Sendmail, la configuración del lado de postfix se limita a «<code
                  class="literal">smtpd_milters = unix:/var/milter-greylist/milter-greylist.sock</code>». La página de manual <span
                  class="citerefentry"><span
                    class="refentrytitle">greylist.conf</span>(5)</span> documenta <code
                  class="filename">/etc/milter-greylist/greylist.conf</code> y las muchas formas de configurar milter-greylist.
			</div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm139951629271904"></a>11.1.5. Personalización de filtros basados en el receptor</h3></div></div></div><div
              class="para">
				Las últimas dos secciones revisaron muchas de las restricciones posibles. Todas son útiles para limitar la cantidad de spam recibido, pero también tienen su desventajas. Por lo tanto, es más y más común, personalizar el conjunto de filtros según el receptor. En Falcot Corp, las listas grises son interesantes para la mayoría de los usuarios pero entorpece el trabajo de algunos usuarios que necesitan una latencia baja en sus correos (como el servicio de soporte técnico). De forma similar, el servicio comercial a veces tiene problemas para recibir correos de algunos proveedores asiáticos que pueden encontrarse en listas negras; este servicio solicitó una dirección sin filtros para poder intercambiar correspondencia.
			</div><div
              class="para">
				Postfix provee tal personalización de filtros con el concepto de «clases de restricción». Declarará las clases en el parámetro <code
                class="literal">smtpd_restriction_classes</code> de la misma forma que <code
                class="literal">smtpd_recipient_restrictions</code>. La directiva <code
                class="literal">check_recipient_access</code> define luego una tabla que asocia un receptor dado con el conjunto de restricciones apropiadas.
			</div><div
              class="example"><a
                id="idm139951629267984"></a><p
                class="title"><strong>Ejemplo 11.13. Definición de clases de restricción en <code
                    class="filename">main.cf</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">smtpd_restriction_classes = greylisting, aggressive, permissive

greylisting = check_policy_service inet:127.0.0.1:10023
aggressive = reject_rbl_client sbl-xbl.spamhaus.org,
        check_policy_service inet:127.0.0.1:10023
permissive = permit

smtpd_recipient_restrictions = permit_mynetworks,
        reject_unauth_destination,
        check_recipient_access hash:/etc/postfix/recipient_access
</pre></div></div><div
              class="example"><a
                id="idm139951629265872"></a><p
                class="title"><strong>Ejemplo 11.14. El archivo <code
                    class="filename">/etc/postfix/recipient_access</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Unfiltered addresses
postmaster@falcot.com  permissive
support@falcot.com     permissive
sales-asia@falcot.com  permissive

# Aggressive filtering for some privileged users
joe@falcot.com         aggressive

# Special rule for the mailing-list manager
sympa@falcot.com       reject_unverified_sender

# Greylisting by default
falcot.com             greylisting
</pre></div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="sect.postfix-antivirus"></a>11.1.6. Integración con un antivirus</h3></div></div></div><a
              id="idm139951629262608"
              class="indexterm"></a><div
              class="para">
				La cantidad de virus circulando como adjuntos de correos hace importante configurar un antivirus en el punto de entrada de la red corporativa, ya que a pesar de una campaña de concientización, algunos usuarios aún abriran los adjuntos de mensajes obviamente sospechosos.
			</div><div
              class="para">
				Los administradores de Falcot seleccionaro <code
                class="command">clamav</code> como su antivirus libre. El paquete principal es <span
                class="pkg pkg">clamav</span>, pero tambien instalaron algunos paquetes adicionales como <span
                class="pkg pkg">arj</span>, <span
                class="pkg pkg">unzoo</span>, <span
                class="pkg pkg">unrar</span> y <span
                class="pkg pkg">lha</span> ya que son necesarios para que el antivirus analice archivos adjuntos en alguno de estos formatos.
			</div><a
              id="idm139951629256704"
              class="indexterm"></a><a
              id="idm139951629255584"
              class="indexterm"></a><div
              class="para">
				La tarea de interactuar entre el antivirus y el servidor de correo le corresponde a <code
                class="command">clamav-milter</code>. Un «<span
                class="emphasis"><em>milter</em></span>» (apócope de «filtro de correo»: «<span
                class="emphasis"><em>mail filter</em></span>») es un programa de filtrado diseñado especialmente para interactuar con servidores de correo. Un milter utiliza una interfaz de programación de aplicaciones (API: «Application Programming Interface») que provee un rendimiento mucho mejor que los filtros ajenos a los servidores de correo. <span
                class="emphasis"><em>Sendmail</em></span> introdujo inicialmente a los milters, pero <span
                class="emphasis"><em>Postfix</em></span> los implementó poco después.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>VISTA RÁPIDA</em></span> Un milter para Spamassassin</strong></p></div></div></div><a
                id="idm139951629250336"
                class="indexterm"></a><div
                class="para">
				El paquete <span
                  class="pkg pkg">spamass-milter</span> provee un milter basado en <span
                  class="emphasis"><em>SpamAssassin</em></span>, el famoso detector de correo no deseado. Puede utilizarlo para marcar mensajes como probable spam (agregando una cabecera adicional) y/o rechazar el mensaje completamente si su «puntaje de spam» supera cierto límite.
			</div></div><div
              class="para">
				Una vez que instaló el paquete <span
                class="pkg pkg">clamav-milter</span>, debería reconfigurar el milter para que ejecute en un puerto TCP en lugar del zócalo con nombre predeterminado. Puede lograr esto ejecutando <code
                class="command">dpkg-reconfigure clamav-milter</code>. Cuando se le pregunte por la «Interfaz de comunicación con Sendmail», responda «<code
                class="literal">inet:10002@127.0.0.1</code>».
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>NOTA</em></span> Puerto TCP real contra zócalo con nombre</strong></p></div></div></div><div
                class="para">
				La razón por la que utilizamos un puerto TCP real en lugar del zócalo con nombres es que los demonios postfix generalmente ejecutan en un chroot y no tienen acceso al directorio que contiene el zócalo con nombre. En caso que decida utilizar el zócalo con nombre, utilice una ubicación dentro del chroot (<code
                  class="filename">/var/spool/postfix/</code>).
			</div></div><div
              class="para">
				La configuración estándar de ClamAV se ajusta a la mayoría de las situaciones, pero puede personalizar algunos parámetros importantes con <code
                class="command">dpkg-reconfigure clamav-base</code>.
			</div><div
              class="para">
				El último paso involucra decirle a Postfix que utilice el filtro recientemente configurado. Esto es tan simple como agregar la siguiente directiva a <code
                class="filename">/etc/postfix/main.cf</code>:
			</div><pre
              class="programlisting">
# Virus check with clamav-milter
smtpd_milters = inet:[127.0.0.1]:10002
</pre><div
              class="para">
				Si el antivirus causa problema, puede comentar esta línea; deberá ejecutar <code
                class="command">/etc/init.d/postfix reload</code> para que se tenga en cuenta el cambio.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>EN LA PRÁCTICA</em></span> Prueba del antivirus</strong></p></div></div></div><div
                class="para">
				Una vez que configuró el antivirus, debe probar que funciona correctamente. La forma más simple de hacerlo es enviar un correo de prueba con un adjunto que contenga el archivo <code
                  class="filename">eicar.com</code> (o <code
                  class="filename">eicar.com.zip</code>) que puede descargar: <div
                  class="url">→ <a
                    href="http://www.eicar.org/anti_virus_test_file.htm">http://www.eicar.org/anti_virus_test_file.htm</a></div>
			</div><div
                class="para">
				Este archivo no es un virus real sino un archivo de prueba que todo software antivirus en el mercado diagnostica como un virus para poder probar instalaciones.
			</div></div><div
              class="para">
				Todos los mensajes gestionados por Postfix ahora pasarán a través del filtro antivirus.
			</div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      id="idm139951629234128"></a>11.1.7. SMTP autenticado</h3></div></div></div><div
              class="para">
				Being able to send emails requires an SMTP server to be reachable; it also requires said SMTP server to send emails through it. For roaming users, this may need regularly changing the configuration of the SMTP client, since Falcot's SMTP server rejects messages coming from IP addresses apparently not belonging to the company. Two solutions exist: either the roaming user installs an SMTP server on their computer, or they still use the company server with some means of authenticating as an employee. The former solution is not recommended since the computer won't be permanently connected, and it won't be able to retry sending messages in case of problems; we will focus on the latter solution.
			</div><div
              class="para">
				La autenticación SMTN en Postfix depende de SASL (<span
                class="emphasis"><em>capa de seguridad y autenticación simple</em></span>: «Simple Authentication and Security Layer»). Necesitará instalar los paquetes <span
                class="pkg pkg">libsasl2-modules</span> y <span
                class="pkg pkg">sasl2-bin</span>, y luego registrar una contraseña en la base de datos SALS para cada usuario que necesite autenticarse en el servidor SMTP. Puede hacerlo con el programa <code
                class="command">saslpasswd2</code> que toma varios parámetros. La opción <code
                class="literal">-u</code> define el dominio de autenticación, que debe coincidir con el parámetro <code
                class="literal">smtpd_sasl_local_domain</code> en la configuración de Postfix. La opción <code
                class="literal">-c</code> permite crear un usuario y la opción <code
                class="literal">-f</code> permite especificar el archivo a utilizar si necesita almacenar la base de datos SALS en una ubicación diferente a la predeterminada (<code
                class="filename">/etc/sasldb2</code>).
			</div><pre
              class="screen scale">
<code
                class="computeroutput"># </code><strong
                class="userinput"><code>saslpasswd2 -u `postconf -h myservidor` -f /var/spool/postfix/etc/sasldb2 -c jean</code></strong>
<code
                class="computeroutput">[... ingrese la contraseña de jean dos veces ...]</code></pre><div
              class="para">
				Note que se creó la base de datos SASL en el directorio de Postfix. Para poder asegurar consistencia, también convertimos <code
                class="filename">/etc/sasldb2</code> en un enlace simbólico que apunta a la base de datos utilizada por Postfix con <code
                class="command">ln -sf /var/spool/postfix/etc/sasldb2 /etc/sasldb2</code>.
			</div><div
              class="para">
				Ahora necesitamos configurar Postfix para que utilice SASL. Primero necesita agregar al usuario <code
                class="literal">postfix</code> al grupo <code
                class="literal">sasl</code> para que pueda acceder a la base de datos SASL. También necesitará agregar algunos parámetros nuevos para activar SASL y necesita configurar el parámetro <code
                class="literal">smtpd_recipient_restrictions</code> para permitir que los clientes autenticados por SASL puedan enviar correos libremente.
			</div><div
              class="example"><a
                id="idm139951629221744"></a><p
                class="title"><strong>Ejemplo 11.15. Activación de SASL en <code
                    class="filename">/etc/postfix/main.cf</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Enable SASL authentication
smtpd_sasl_auth_enable = yes
# Define the SASL authentication domain to use
smtpd_sasl_local_domain = $myhostname
[...]
# Adding permit_sasl_authenticated before reject_unauth_destination
# allows relaying mail sent by SASL-authenticated users
smtpd_recipient_restrictions = permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination,
[...]
</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>EXTRA</em></span> Cliente SMTP autenticado</strong></p></div></div></div><div
                class="para">
				La mayoría de los clientes de correo pueden autenticarse con un servidor SMTP antes de enviar mensajes, y utilizar esta funcionalidad es tan simple como configurar los parámetros apropiados. Si el cliente utilizado no provee esta funcionalidad, puede utilizar un servidor Postfix local y configurarlo para reenviar el correo a través de un servidor SMTP remoto. En este caso, el Postfix local será el cliente que se autentica con SASL. Estos son los parámetros necesarios:
			</div><pre
                class="programlisting">
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
relay_host = [mail.falcot.com]
</pre><div
                class="para">
				El archivo <code
                  class="filename">/etc/postfix/sasl_passwd</code> necesita contener el nombre de usuarios y la contraseña a utilizar para autenticarse en el servidor <code
                  class="literal">mail.falcot.com</code>. Por ejemplo:
			</div><pre
                class="programlisting">
[mail.falcot.com]   joe:LyinIsji
</pre><div
                class="para">
				Como en todos los archivos de asociación de Postfix, debe convertir este archivo en <code
                  class="filename">/etc/postfix/sasl_passwd.db</code> con el programa <code
                  class="command">postmap</code>.
			</div></div></div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="sect.network-diagnosis-tools.html"><strong>Anterior</strong>10.8. Herramientas de diagnóstico de red</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>Subir</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>Inicio</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.http-web-server.html"><strong>Siguiente</strong>11.2. Servidor web (HTTP)</a></li></ul><div
        id="translated_pages"><ul><li><a
              href="../ar-MA/network-services.html">ar-MA</a></li><li><a
              href="../da-DK/network-services.html">da-DK</a></li><li><a
              href="../de-DE/network-services.html">de-DE</a></li><li><a
              href="../el-GR/network-services.html">el-GR</a></li><li><a
              href="../en-US/network-services.html">en-US</a></li><li><a
              href="../es-ES/network-services.html">es-ES</a></li><li><a
              href="../fa-IR/network-services.html">fa-IR</a></li><li><a
              href="../fr-FR/network-services.html">fr-FR</a></li><li><a
              href="../hr-HR/network-services.html">hr-HR</a></li><li><a
              href="../id-ID/network-services.html">id-ID</a></li><li><a
              href="../it-IT/network-services.html">it-IT</a></li><li><a
              href="../ja-JP/network-services.html">ja-JP</a></li><li><a
              href="../pl-PL/network-services.html">pl-PL</a></li><li><a
              href="../pt-BR/network-services.html">pt-BR</a></li><li><a
              href="../ro-RO/network-services.html">ro-RO</a></li><li><a
              href="../ru-RU/network-services.html">ru-RU</a></li><li><a
              href="../tr-TR/network-services.html">tr-TR</a></li><li><a
              href="../zh-CN/network-services.html">zh-CN</a></li></ul></div></body></html>
