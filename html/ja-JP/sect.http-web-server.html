<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">11.2. ウェブサーバ (HTTP)</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.1" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-8-ja-JP-1.0-1" /><meta
        name="keywords"
        content="Postfix, Apache, NFS, Samba, Squid, OpenLDAP" /><link
        rel="home"
        href="index.html"
        title="Debian 管理者ハンドブック" /><link
        rel="up"
        href="network-services.html"
        title="第11章 ネットワークサービス: Postfix、Apache、NFS、Samba、Squid、LDAP" /><link
        rel="prev"
        href="network-services.html"
        title="第11章 ネットワークサービス: Postfix、Apache、NFS、Samba、Squid、LDAP" /><link
        rel="next"
        href="sect.ftp-file-server.html"
        title="11.3. FTP ファイルサーバ" /><link
        rel="canonical"
        href="http://l.github.io/debian-handbook/html/ja-JP/sect.http-web-server.html" /></head><body
      class="draft "><noscript><iframe
          src="//www.googletagmanager.com/ns.html?id=GTM-5H35QX"
          height="0"
          width="0"
          style="display:none;visibility:hidden"></iframe></noscript><script
        type="text/javascript">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&amp;l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5H35QX');</script><div
        id="banner"><a
          href="http://debian-handbook.info/get/"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="http://debian-handbook.info"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="network-services.html"><strong>戻る</strong></a></li><li
          class="home">Debian 管理者ハンドブック</li><li
          class="next"><a
            accesskey="n"
            href="sect.ftp-file-server.html"><strong>次へ</strong></a></li></ul><div
        class="section"><div
          class="titlepage"><div><div><h2
                class="title"><a
                  id="sect.http-web-server"></a>11.2. ウェブサーバ (HTTP)</h2></div></div></div><div
          class="para">
			Falcot Corp 管理者は Debian <span
            class="distribution distribution">Jessie</span> に含まれるバージョン 2.4.10 の Apache HTTP サーバを使うことに決めました。
		</div><a
          id="idm140245157386480"
          class="indexterm"></a><a
          id="idm140245157385360"
          class="indexterm"></a><a
          id="idm140245157383920"
          class="indexterm"></a><a
          id="idm140245157382960"
          class="indexterm"></a><a
          id="idm140245157381520"
          class="indexterm"></a><div
          class="sidebar"><div
            class="titlepage"><div><div><p
                  class="title"><strong><span
                      class="emphasis"><em>ALTERNATIVE</em></span> 他のウェブサーバ</strong></p></div></div></div><div
            class="para">
			Apache は最も広く知られている (最も広く使われている) ウェブサーバですが、他にもウェブサーバは存在します; これらのサーバはわずかな負荷で高い性能を発揮しますが、利用できる機能やモジュールが少ないという欠点も持っています。しかしながら、静的ファイルを提供する用途やプロキシ用途にウェブサーバを使う場合、<span
              class="pkg pkg">nginx</span> や <span
              class="pkg pkg">lighttpd</span> などの代替品は調査する価値があります。
		</div><a
            id="idm140245157376768"
            class="indexterm"></a><a
            id="idm140245157375344"
            class="indexterm"></a></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    id="idm140245157373760"></a>11.2.1. Apache のインストール</h3></div></div></div><div
            class="para">
				デフォルトで、<span
              class="pkg pkg">apache2</span> パッケージをインストールすると Apache の <span
              class="pkg pkg">apache2-mpm-worker</span> バージョンがインストールされます。<span
              class="pkg pkg">apache2</span> パッケージはメタパッケージであり、Apache バージョンの 1 つが実際にインストールされていることを確保するためだけに提供されています。
			</div><div
            class="para">
				Apache 2 の亜種同士の主な違いは、多くのリクエストを並列処理する際の取り扱い方法に関するポリシーです; このポリシーは MPM (<span
              class="emphasis"><em>Multi-Processing Module</em></span> の略) によって実装されています。利用できる MPM の中でも特に、<span
              class="emphasis"><em>worker</em></span> は <span
              class="emphasis"><em>スレッド</em></span> (軽量プロセス) を使います。これに対して <span
              class="emphasis"><em>prefork</em></span> はあらかじめ生成したプロセスプール (古典的方法、Apache 1.3 ではこれしか使えません) を使います。<span
              class="emphasis"><em>event</em></span> はスレッドを使いますが、入って来る接続が HTTP の <span
              class="emphasis"><em>keep-alive</em></span> 機能を使ってオープン状態を保存するためだけのものの場合、スレッドを早く終わらせます。
			</div><div
            class="para">
				Falcot の管理者はさらに Apache で PHP サポートを有効化するために <span
              class="pkg pkg">libapache2-mod-php5</span> をインストールします。こうすることで、<span
              class="emphasis"><em>worker</em></span> MPM が削除され、代わりに <span
              class="emphasis"><em>prefork</em></span> MPM がインストールされます。なぜなら、 PHP はこの MPM の下でしか動かないからです。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>SECURITY</em></span> <code
                        class="literal">www-data</code> ユーザ下の実行</strong></p></div></div></div><a
              id="idm140245157362032"
              class="indexterm"></a><a
              id="idm140245157360912"
              class="indexterm"></a><div
              class="para">
				デフォルトで、Apache は入って来るリクエストを <code
                class="literal">www-data</code> ユーザからのリクエストとして取り扱います。これは、Apache が実行する CGI スクリプト (動的ページ) の持つセキュリティ脆弱性によって、システム全体が危険にさらされるのではなく、特定のユーザが所有するファイルだけに被害を留めることが可能であることを意味しています。
			</div><div
              class="para">
				<span
                class="emphasis"><em>suexec</em></span> モジュールを使うことで、このルールを迂回することが可能です。こうすることで、一部の CGI スクリプトを別のユーザの権限で実行することが可能です。設定を行うには、Apache 設定ファイルの <code
                class="literal">SuexecUserGroup <em
                  class="replaceable">user</em><em
                  class="replaceable">group</em></code> 指示文を使います。
			</div><a
              id="idm140245157356288"
              class="indexterm"></a><div
              class="para">
				もう一つの可能性は、たとえば <span
                class="pkg pkg">libapache2-mpm-itk</span> の提供する MPM などの、専用 MPM を使うことです。この専用 MPM の挙動は少し異なります: これは仮想ホスト (実質的にはページ群) を「隔離」し、各仮想ホストを異なるユーザの権限で実行します。このため、あるウェブサイトの持つ脆弱性によって、他のウェブサイトの所有者の持つファイルが危険にさらされることがなくなります。
			</div></div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>QUICK LOOK</em></span> モジュールのリスト</strong></p></div></div></div><div
              class="para">
				Apache の標準的なモジュールをオンラインで見ることが可能です。<div
                class="url">→ <a
                  href="http://httpd.apache.org/docs/2.4/mod/index.html">http://httpd.apache.org/docs/2.4/mod/index.html</a></div>
			</div></div><div
            class="para">
				Apache はモジュール式サーバで、多くの機能が外部モジュールによって実装されており、主プログラムは初期化の際に外部モジュールを読み込みます。デフォルト設定では、最も一般的なモジュールだけが有効化されていますが、新しいモジュールの有効化は <code
              class="command">a2enmod <em
                class="replaceable">module</em></code> を実行するだけで簡単に行うことが可能です; モジュールを無効化するコマンドは <code
              class="command">a2dismod <em
                class="replaceable">module</em></code> です。実際のところ、これらのプログラムは <code
              class="filename">/etc/apache2/mods-enabled/</code> 内に実際のファイル (<code
              class="filename">/etc/apache2/mods-available/</code> 内に保存されている) を指すシンボリックリンクを作成 (削除) しているだけです。
			</div><div
            class="para">
				Apache のデフォルト設定では、ウェブサーバはポート 80 番をリッスンし (<code
              class="filename">/etc/apache2/ports.conf</code> の中で設定されています)、<code
              class="filename">/var/www/</code> ディレクトリに含まれるページを提供します (<code
              class="filename">/etc/apache2/sites-enabled/000-default</code> の中で設定されています)。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>GOING FURTHER</em></span> SSL サポートの追加</strong></p></div></div></div><a
              id="idm140245157343776"
              class="indexterm"></a><a
              id="idm140245157342816"
              class="indexterm"></a><div
              class="para">
				Apache 2.4 には、すぐに使える安全な HTTP (HTTPS) に必要な SSL モジュールが含まれます。これを有効化するには、<code
                class="command">a2enmod ssl</code> を使い、必要な指示文を設定ファイルに追加しなければいけません。設定例は <code
                class="filename">/etc/apache2/sites-available/default-ssl.conf</code> で提供されています。<div
                class="url">→ <a
                  href="http://httpd.apache.org/docs/2.4/mod/mod_ssl.html">http://httpd.apache.org/docs/2.4/mod/mod_ssl.html</a></div>
			</div><div
              class="para">
				<span
                class="emphasis"><em>Perfect Forward Secrecy</em></span> を使った SSL 接続を優先したい場合、一部の特別な注意が必要です (これらの接続は一時的なセッション鍵を使い、サーバの秘密鍵が漏洩した場合でもネットワークのスニッフィングを行うことで保存される可能性がある古い暗号化されたトラフィックの内容が漏洩しないことを保証します)。特に Mozilla の推奨する設定例をご覧ください: <div
                class="url">→ <a
                  href="https://wiki.mozilla.org/Security/Server_Side_TLS#Apache">https://wiki.mozilla.org/Security/Server_Side_TLS#Apache</a></div>
			</div><a
              id="idm140245157336496"
              class="indexterm"></a></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    id="idm140245157335056"></a>11.2.2. 仮想ホストの設定</h3></div></div></div><div
            class="para">
				仮想ホスト機能を使うことで、ウェブサーバに複数の身元を運用させることが可能です。
			</div><a
            id="idm140245157333696"
            class="indexterm"></a><div
            class="para">
				Apache は異なる 2 種類の仮想ホストを取り扱うことが可能です: IP アドレス (またはポート番号) またはウェブサーバのドメイン名に基づいて仮想ホスト機能が実装されています。1 番目の方法を使う場合、各サイトに異なる IP アドレス (またはポート番号) を割り当てることが必要です。これに対して、2 番目の方法を使う場合、単一の IP アドレス (またはポート番号) で複数のサイトを運用することが可能で、HTTP クライアントの送信するホスト名によってサイトを識別します (こちらの方法は HTTP プロトコルのバージョン 1.1 で動作します — 幸いなことに、バージョン 1.1 はすべてのクライアントが対応していると考えて良い程度に古いプロトコルです)。
			</div><div
            class="para">
				IPv4 アドレスは (ますます) 不足し続けているため、通常 2 番目の方法が好まれます; しかしながらこの方法では、仮想ホストが HTTPS を提供する必要がある場合、より複雑です。なぜなら、SSL プロトコルは常にホスト名に基づく仮想ホスト機能を規定しているとは限らないからです; そのような組み合わせを可能にする SNI 拡張 (<span
              class="emphasis"><em>Server Name Indication</em></span>) はすべてのブラウザで正しく使えるとは限りません。1 つのサーバで複数の HTTPS サイトを運用する必要がある場合、HTTPS サイトは通常異なるポートを使うか、異なる IP アドレスを使う (IPv6 が役立ちます) ことで識別されます。
			</div><div
            class="para">
				Apache 2 のデフォルト設定では、ホスト名に基づく仮想ホスト機能が有効にされています。加えて、<code
              class="literal">/etc/apache2/sites-enabled/000-default</code> ファイルの中でデフォルトの仮想ホストが定義されています; クライアントによって送信された要求に一致するホストが見つからない場合、この仮想ホストが使われます。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>CAUTION</em></span> 最初の仮想ホスト</strong></p></div></div></div><div
              class="para">
				不明な仮想ホストに関する要求は最初に定義された仮想ホストへの要求として処理されます。このため 管理者は <code
                class="literal">www.falcot.com</code> を最初に定義しています。
			</div></div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>QUICK LOOK</em></span> Apache の SNI サポート</strong></p></div></div></div><a
              id="idm140245157325008"
              class="indexterm"></a><div
              class="para">
				Apache サーバは <span
                class="emphasis"><em>Server Name Indication</em></span> (SNI) と呼ばれる SSL プロトコル拡張をサポートします。SNI 拡張を使うことで、ブラウザは SSL 接続を確立する間の HTTP 要求よりもずっと前にウェブサーバのホスト名を送信することが可能になり、同じサーバ (同じ IP アドレスとポート番号を使う) でホストされているホストから要求された仮想ホストを識別します。これを使うことで、Apache は以降のトランザクションで最も適切な SSL 証明書を選びます。
			</div><div
              class="para">
				SNI の前に、Apache は常にデフォルトの仮想ホストの定義する証明書を使います。他の仮想ホストへのアクセスを試行するクライアントは警告を表示するかもしれません。なぜなら、クライアントが受け取った証明書はアクセスしようとしているウェブサイトと一致しないからです。幸いなことに、ほとんどのブラウザは SNI を取り扱うことが可能です; Microsoft Internet Explorer バージョン 7.0 以降 (かつ Vista 以降)、Mozilla Firefox バージョン 2.0 以降、Apple Safari バージョン 3.2.1 以降、Google Chrome のすべてのバージョン。
			</div><div
              class="para">
				Debian の提供する Apache パッケージは SNI サポートを有効化した状態でビルドされています; 特別な設定は不要です。
			</div><div
              class="para">
				最初の仮想ホスト (デフォルトで使われる) に対する設定で TLSv1 を有効化することを忘れないでください。なぜなら、Apache は安全な接続を確立するためにこの最初の仮想ホストのパラメータを使うため、パラメータで安全な接続を許すべきです!
			</div></div><div
            class="para">
				仮想ホストを追加するには、<code
              class="filename">/etc/apache2/sites-available/</code> にファイルを追加します。<code
              class="literal">falcot.org</code> ドメインで運用されるウェブサイトをセットアップするには、以下のファイルを作成し、<code
              class="command">a2ensite www.falcot.org</code> を使って仮想ホストを有効化するだけで簡単に可能です。
			</div><div
            class="example"><a
              id="idm140245157317952"></a><p
              class="title"><strong>例11.16 <code
                  class="filename">/etc/apache2/sites-available/www.falcot.org</code> ファイル</strong></p><div
              class="example-contents"><pre
                class="programlisting">
&lt;VirtualHost *:80&gt;
ServerName www.falcot.org
ServerAlias falcot.org
DocumentRoot /srv/www/www.falcot.org
&lt;/VirtualHost&gt;</pre></div></div><div
            class="para">
				ここまでの設定に従うと、Apache サーバはすべての仮想ホストに対して同じログファイルを使います (仮想ホストの定義に <code
              class="literal">CustomLog</code> 指示文を追加すればこの挙動を変えることが可能です)。そのため、ログファイルのフォーマットをカスタマイズして、仮想ホストの名前を含むようにすることが道理にかなっています。これを行うには、<code
              class="filename">/etc/apache2/conf.d/customlog</code> ファイルを作成してすべてのログファイルに対する新しいフォーマットを定義します (<code
              class="literal">LogFormat</code> 指示文を使います)。また、<code
              class="filename">/etc/apache2/sites-available/default</code> ファイルから <code
              class="literal">CustomLog</code> 指示文を削除 (またはコメントアウト) しなければいけません。
			</div><div
            class="example"><a
              id="idm140245157312736"></a><p
              class="title"><strong>例11.17 <code
                  class="filename">/etc/apache2/conf.d/customlog</code> ファイル</strong></p><div
              class="example-contents"><pre
                class="programlisting scale">
# New log format including (virtual) host name
LogFormat "%v %h %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\"" vhost

# Now let's use this "vhost" format by default
CustomLog /var/log/apache2/access.log vhost</pre></div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    id="idm140245157310336"></a>11.2.3. よく使われる指示文</h3></div></div></div><div
            class="para">
				この節では、いくつかのよく使われる Apache 設定指示文を簡単に見直します。
			</div><a
            id="idm140245157308992"
            class="indexterm"></a><a
            id="idm140245157308032"
            class="indexterm"></a><div
            class="para">
				主要設定ファイルにはいくつかの <code
              class="literal">Directory</code> ブロックが含まれます; これを使うことで、提供されるファイルの位置に従って、サーバの挙動を変えることが可能です。<code
              class="literal">Directory</code> ブロックには通常 <code
              class="literal">Options</code> と <code
              class="literal">AllowOverride</code> 指示文が含まれます。
			</div><a
            id="idm140245157304624"
            class="indexterm"></a><a
            id="idm140245157303344"
            class="indexterm"></a><div
            class="example"><a
              id="idm140245157302064"></a><p
              class="title"><strong>例11.18 Directory ブロック</strong></p><div
              class="example-contents"><pre
                class="programlisting">
&lt;Directory /var/www&gt;
Options Includes FollowSymlinks
AllowOverride All
DirectoryIndex index.php index.html index.htm
&lt;/Directory&gt;</pre></div></div><div
            class="para">
				<code
              class="literal">DirectoryIndex</code> 指示文には、クライアントからディレクトリを要求された場合に応答として送信するファイルのリストを指定します。リスト内の最初に見つかったファイルが、応答として使われます。
			</div><a
            id="idm140245157299312"
            class="indexterm"></a><div
            class="para">
				<code
              class="literal">Options</code> 指示文には、有効化するオプションを指定します。<code
              class="literal">None</code> 値はすべてのオプションを無効化します; 対して <code
              class="literal">All</code> は <code
              class="literal">MultiViews</code> を除いてすべてのオプションを有効化します。利用できるオプションは以下です:
			</div><div
            xmlns:d="http://docbook.org/ns/docbook"
            class="itemizedlist"><ul><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">ExecCGI</code> は CGI スクリプトが実行可能なことを意味します。<a
                    id="idm140245157293952"
                    class="indexterm"></a>
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">FollowSymlinks</code> を使うことで、シンボリックリンクをたどることが可能であること、リンク先の内容を応答として返すことをサーバに伝えます。<a
                    id="idm140245157291392"
                    class="indexterm"></a>
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">SymlinksIfOwnerMatch</code> を使うことで、シンボリックリンクとリンク先が同じ所有者の場合に限り、シンボリックリンクをたどることが可能であることをサーバに伝えます。<a
                    id="idm140245157288800"
                    class="indexterm"></a>
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">Includes</code> を使うことで、<span
                    class="emphasis"><em>Server Side Includes</em></span> (略して <span
                    class="emphasis"><em>SSI</em></span>) が有効化されます。SSI は HTML ページの中に埋め込まれ、要求ごとにその場で実行される指示です。<a
                    id="idm140245157285328"
                    class="indexterm"></a>
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">Indexes</code> を使うことで、クライアントの送信した HTTP 要求が index ファイルの含まれないディレクトリを指している場合 (たとえば <code
                    class="literal">DirectoryIndex</code> 指示文でリストされているファイルがこのディレクトリ内に存在しない場合)、ディレクトリの内容をリストすることをサーバに伝えます。<a
                    id="idm140245157282128"
                    class="indexterm"></a>
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">MultiViews</code> を使うことで、コンテンツネゴシエーションが有効化されます; サーバはこれを使って、ブラウザで設定した優先言語に一致するウェブページを返します。<a
                    id="idm140245157279536"
                    class="indexterm"></a>
					</div></li></ul></div><div
            class="para">
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>BACK TO BASICS</em></span> <code
                        class="filename">.htaccess</code> ファイル</strong></p></div></div></div><div
              class="para">
				<code
                class="filename">.htaccess</code> ファイルには、Apache 設定指示文が含まれます。その設定内容は、<code
                class="filename">.htaccess</code> ファイルが保存されているディレクトリに含まれる要素が要求された時に、強制されます。指示文の有効範囲は <code
                class="filename">.htaccess</code> が保存されているディレクトリ以下すべてのサブディレクトリです。
			</div><a
              id="idm140245157273792"
              class="indexterm"></a><div
              class="para">
				<code
                class="literal">Directory</code> ブロック内に書かれたほとんどの指示文は <code
                class="filename">.htaccess</code> ファイル内でも使うことが可能です。
			</div></div><div
            class="para">
				<code
              class="literal">AllowOverride</code> 指示文は <code
              class="filename">.htaccess</code> ファイルを使って有効化または無効化されたすべてのオプションをリストします。このオプションは一般に <code
              class="literal">ExecCGI</code> を制限するために使われることが多いです。管理者はウェブサーバ (<code
              class="literal">www-data</code> ユーザ) の権限でプログラムを実行することを許可するユーザを選択します。
			</div><a
            id="idm140245157268272"
            class="indexterm"></a><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      id="idm140245157266992"></a>11.2.3.1. 認証要求</h4></div></div></div><a
              id="idm140245157266192"
              class="indexterm"></a><div
              class="para">
					ウェブサイトのある部分へのアクセスを制限し、ユーザ名とパスワードに基づく正当なユーザだけが内容にアクセスできるように設定する必要があるかもしれません。
				</div><div
              class="example"><a
                id="idm140245157264528"></a><p
                class="title"><strong>例11.19 認証要求を行う <code
                    class="filename">.htaccess</code> ファイル</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
Require valid-user
AuthName "Private directory"
AuthType Basic
AuthUserFile /etc/apache2/authfiles/htpasswd-private</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>SECURITY</em></span> 無意味なセキュリティ</strong></p></div></div></div><div
                class="para">
					上の例で使われている (<code
                  class="literal">Basic</code>) 認証システムは最低限のセキュリティを提供します。パスワードは平文で送信されます (パスワードは暗号化よりも単純な符号化である <span
                  class="emphasis"><em>base64</em></span> で符号化されるだけです)。この認証システムで「保護」されている文書はネットワークを平文で送信される点も注意するべきです。セキュリティが重要な場合、HTTP 接続全体を SSL で暗号化するべきです。
				</div></div><div
              class="para">
					<code
                class="filename">/etc/apache2/authfiles/htpasswd-private</code> ファイルには、ユーザとパスワードのリストが含まれます; このファイルを操作するには通常 <code
                class="command">htpasswd</code> コマンドを使います。たとえば、以下のコマンドを使うことで、ユーザを追加するかユーザのパスワードを変更します: <a
                id="idm140245157257904"
                class="indexterm"></a>
				</div><pre
              class="screen">
<code
                class="computeroutput"># </code><strong
                class="userinput"><code>htpasswd /etc/apache2/authfiles/htpasswd-private <em
                    class="replaceable">user</em>
</code></strong><code
                class="computeroutput">New password:
Re-type new password:
Adding password for user <em
                  class="replaceable">user</em>
</code></pre></div><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      id="idm140245157254368"></a>11.2.3.2. アクセス制限</h4></div></div></div><a
              id="idm140245157253568"
              class="indexterm"></a><div
              class="para">
					<code
                class="literal">Require</code> 指示文を使うことで、あるディレクトリへのアクセスを制御 (とサブディレクトリへのアクセスを再帰的に制御) します。
				</div><a
              id="idm140245157251520"
              class="indexterm"></a><a
              id="idm140245157250560"
              class="indexterm"></a><a
              id="idm140245157249600"
              class="indexterm"></a><div
              class="para">
					<code
                class="literal">Require</code> 指示文は多くの基準を基にアクセスを制限するために使われます; われわれはクライアントの IP アドレスに基づいてアクセス制限の基準を表現することを止め、より強力なアクセス制限の基準を、特にいくつかの <code
                class="literal">Require</code> 指示文を <code
                class="literal">RequireAll</code> ブロックと組み合わせることで、表現します。
				</div><div
              class="example"><a
                id="idm140245157246080"></a><p
                class="title"><strong>例11.20 ローカルネットワークからのアクセスだけを許可する例</strong></p><div
                class="example-contents"><pre
                  class="programlisting">Require ip 192.168.0.0/16</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>ALTERNATIVE</em></span> 古い構文</strong></p></div></div></div><div
                class="para">
					<code
                  class="literal">Require</code> 指示文は Apache 2.4 (<span
                  class="distribution distribution">Jessie</span> で提供されるバージョン) でのみ利用できます。<span
                  class="distribution distribution">Wheezy</span> のユーザ向けの説明になりますが、Apache 2.2 の構文は異なります。ここでは主に参照用として Apache 2.2 の構文を説明しますが、この構文は <code
                  class="literal">mod_access_compat</code> モジュールを使えば Apache 2.4 でも利用できます。
				</div><div
                class="para">
					<code
                  class="literal">Allow from</code> と <code
                  class="literal">Deny from</code> 指示文を使うことで、あるディレクトリへのアクセスを制御 (とサブディレクトリへのアクセスを再帰的に制御) します。
				</div><a
                id="idm140245157238816"
                class="indexterm"></a><a
                id="idm140245157237536"
                class="indexterm"></a><a
                id="idm140245157236256"
                class="indexterm"></a><div
                class="para">
					<code
                  class="literal">Order</code> 指示文を使うことで、<code
                  class="literal">Allow from</code> と <code
                  class="literal">Deny from</code> 指示文を評価する順番をサーバに伝えます; 最後に一致したものが優先されます。具体的に言えば、<code
                  class="literal">Order deny,allow</code> を使うと、<code
                  class="literal">Deny from</code> に一致しないホストまたは <code
                  class="literal">Allow from</code> に一致するホストからのアクセスを許可します。反対に、<code
                  class="literal">Order allow,deny</code> を使うと、<code
                  class="literal">Allow from</code> に一致しないホスト (または <code
                  class="literal">Deny from</code> に一致するホスト) からのアクセスを拒否します。
				</div><div
                class="para">
					<code
                  class="literal">Allow from</code> と <code
                  class="literal">Deny from</code> 指示文には、IP アドレス、ネットワーク (たとえば <code
                  class="literal">192.168.0.0/255.255.255.0</code>、<code
                  class="literal">192.168.0.0/24</code>、<code
                  class="literal">192.168.0</code> など)、ホスト名、ドメイン名、全員を意味する <code
                  class="literal">all</code> キーワードを使うことが可能です。
				</div><div
                class="example"><a
                  id="idm140245157226832"></a><p
                  class="title"><strong>例11.21 デフォルトで拒否して、ローカルネットワークからのアクセスを許可する例</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
Order deny,allow
Allow from 192.168.0.0/16
Deny from all</pre></div></div></div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    id="idm140245157224784"></a>11.2.4. ログ解析ソフトウェア</h3></div></div></div><div
            class="para">
				ウェブサーバには、通常ログ解析ソフトウェアがインストールされます; なぜなら、ログ解析ソフトウェアを使うことで、管理者はウェブサーバの使用形態に関する正確な知見を得ることが可能だからです。
			</div><div
            class="para">
				Falcot Corp 管理者は <span
              class="emphasis"><em>AWStats</em></span> (<span
              class="emphasis"><em>Advanced Web Statistics</em></span>) を使って Apache ログファイルを解析することに決めました。
			</div><a
            id="idm140245157221888"
            class="indexterm"></a><a
            id="idm140245157220768"
            class="indexterm"></a><a
            id="idm140245157219840"
            class="indexterm"></a><a
            id="idm140245157218432"
            class="indexterm"></a><div
            class="para">
				最初に <code
              class="filename">/etc/awstats/awstats.conf</code> ファイルをカスタマイズして設定を行います。Falcot 管理者は以下のパラメータだけを修正し、他はそのままの状態にしています:
			</div><pre
            class="programlisting">
LogFile="/var/log/apache2/access.log"
LogFormat = "%virtualname %host %other %logname %time1 %methodurl %code %bytesd %refererquot %uaquot"
SiteDomain="www.falcot.com"
HostAliases="falcot.com REGEX[^.*\.falcot\.com$]"
DNSLookup=1
LoadPlugin="tooltips"</pre><div
            class="para">
				これらのパラメータに関する説明はテンプレートファイルにコメントとして書かれています。特に、<code
              class="varname">LogFile</code> と <code
              class="varname">LogFormat</code> パラメータを使って、ログファイルの場所とログファイルに含まれる情報の書式を指定します; <code
              class="varname">SiteDomain</code> と <code
              class="varname">HostAliases</code> は主要ウェブサイトに与えられている複数の名前をリストします。
			</div><div
            class="para">
				トラフックの多いサイトでは、通常 <code
              class="varname">DNSLookup</code> を <code
              class="literal">1</code> に設定するべきではありません; トラフィックの少ないサイトでは、Falcot の設定と同様に、<code
              class="varname">DNSLookup</code> を設定することで、解析結果に生 IP アドレスではなく完全なマシン名が含まれるようになり、読みやすくなります。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>SECURITY</em></span> 統計へのアクセス</strong></p></div></div></div><div
              class="para">
				AWStats は統計をウェブサイト上で利用できるようにしており、デフォルトでは統計へのアクセスは制限されていません。しかし、ごく少数の (おそらく内部の) IP アドレスだけがアクセスできるように制限をかけることも可能です; アクセスを許可する IP アドレスのリストは <code
                class="varname">AllowAccessFromWebToFollowingIPAddresses</code> パラメータで定義する必要があります。
			</div></div><div
            class="para">
				他の仮想ホストに対して AWStats を有効化することも可能です; 各仮想ホストに対して、<code
              class="filename">/etc/awstats/awstats.www.falcot.org.conf</code> などの設定ファイルを作ってください。
			</div><div
            class="example"><a
              id="idm140245157207168"></a><p
              class="title"><strong>例11.22 仮想ホスト用の AWStats 設定ファイル</strong></p><div
              class="example-contents"><pre
                class="programlisting">
Include "/etc/awstats/awstats.conf"
SiteDomain="www.falcot.org"
HostAliases="falcot.org"</pre></div></div><div
            class="para">
				AWStats は <code
              class="filename">/usr/share/awstats/icon/</code> ディレクトリに保存されている多くのアイコンを使います。ウェブサイトでこれらのアイコンを使えるようにするためには、以下の指示文を Apache の設定に追加する必要があります:
			</div><pre
            class="programlisting">
Alias /awstats-icon/ /usr/share/awstats/icon/</pre><div
            class="para">
				数分後 (スクリプトを複数回実行した後)、結果をオンラインで見ることが可能になります: <div
              class="url">→ <a
                href="http://www.falcot.com/cgi-bin/awstats.pl">http://www.falcot.com/cgi-bin/awstats.pl</a></div><div
              class="url">→ <a
                href="http://www.falcot.org/cgi-bin/awstats.pl">http://www.falcot.org/cgi-bin/awstats.pl</a></div>
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>CAUTION</em></span> ログファイルの循環</strong></p></div></div></div><div
              class="para">
				統計はすべてのログに対して取られるため、Apache ログファイルが循環される直前に <span
                class="emphasis"><em>AWStats</em></span> を実行する必要があります。<code
                class="filename">/etc/logrotate.d/apache2</code> ファイルの <code
                class="literal">prerotate</code> 指示文から判断すると、これを解決するには、<code
                class="filename">/usr/share/awstats/tools/update.sh</code> へのシンボリックリンクを <code
                class="filename">/etc/logrotate.d/httpd-prerotate</code> に作成します:
			</div><pre
              class="screen">
$ <strong
                class="userinput"><code>cat /etc/logrotate.d/apache2</code></strong>
/var/log/apache2/*.log {
  weekly
  missingok
  rotate 52
  compress
  delaycompress
  notifempty
  create 644 root adm
  sharedscripts
  postrotate
    /etc/init.d/apache2 reload &gt; /dev/null
  endscript
  prerotate
    if [ -d /etc/logrotate.d/httpd-prerotate ]; then \
      run-parts /etc/logrotate.d/httpd-prerotate; \
    fi; \
  endscript
}
$ <strong
                class="userinput"><code>sudo mkdir -p /etc/logrotate.d/httpd-prerotate</code></strong>
$ <strong
                class="userinput"><code>sudo ln -sf /usr/share/awstats/tools/update.sh \
  /etc/logrotate.d/httpd-prerotate/awstats</code></strong></pre><div
              class="para">
				<code
                class="command">logrotate</code> によって作成されたログファイルは誰でも、特に AWStats から、読み取り可能にしておく必要があります。上の例では、(デフォルトの <code
                class="literal">640</code> パーミッションの代わりに) <code
                class="literal">create 644 root adm</code> 行を追加することでこれを実現しています。
			</div></div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="network-services.html"><strong>戻る</strong>第11章 ネットワークサービス: Postfix、Apache、NFS、Samba、Squid、L...</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>上に戻る</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>ホーム</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.ftp-file-server.html"><strong>次へ</strong>11.3. FTP ファイルサーバ</a></li></ul><div
        id="translated_pages"><ul><li><a
              href="../ar-MA/sect.http-web-server.html">ar-MA</a></li><li><a
              href="../da-DK/sect.http-web-server.html">da-DK</a></li><li><a
              href="../de-DE/sect.http-web-server.html">de-DE</a></li><li><a
              href="../el-GR/sect.http-web-server.html">el-GR</a></li><li><a
              href="../en-US/sect.http-web-server.html">en-US</a></li><li><a
              href="../es-ES/sect.http-web-server.html">es-ES</a></li><li><a
              href="../fa-IR/sect.http-web-server.html">fa-IR</a></li><li><a
              href="../fr-FR/sect.http-web-server.html">fr-FR</a></li><li><a
              href="../hr-HR/sect.http-web-server.html">hr-HR</a></li><li><a
              href="../id-ID/sect.http-web-server.html">id-ID</a></li><li><a
              href="../it-IT/sect.http-web-server.html">it-IT</a></li><li><a
              href="../ja-JP/sect.http-web-server.html">ja-JP</a></li><li><a
              href="../pl-PL/sect.http-web-server.html">pl-PL</a></li><li><a
              href="../pt-BR/sect.http-web-server.html">pt-BR</a></li><li><a
              href="../ro-RO/sect.http-web-server.html">ro-RO</a></li><li><a
              href="../ru-RU/sect.http-web-server.html">ru-RU</a></li><li><a
              href="../tr-TR/sect.http-web-server.html">tr-TR</a></li><li><a
              href="../zh-CN/sect.http-web-server.html">zh-CN</a></li></ul></div></body></html>
